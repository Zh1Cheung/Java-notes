## **什么是分布式数据库**

- **分布式数据库是服务于写多读少、低延时、海量并发 OLTP 场景的，具备海量数据存储能力和高可靠性的关系型数据库**。
- 外部视角
  - 定义1.0 OLTP关系型数据库
    - 写多读少、低延时、高并发
      - 之所以强调写多读少，因为写操作的负载只能是单体数据库的主节点上，是无法 转移的;而读操作，如果对一致性要求不高可以转移到备节点，甚至在某些条件下还能保证一致 性。就是说单体数据库可以通过一主多备解决读负载大的问题，而无需引入分布式数据库
  - 定义 2.0 + 海量并发
    - 传统关系型数据库往往是单机模式，也就是主要负载运行在一台机器上。这样，数据库的 并发处理能力与单机的资源配置是线性相关的，所以并发处理能力的上限也就受限于单机 配置的上限。这种依靠提升单机资源配置来扩展性能的方式，被称为**垂直扩展**(Scale Up)。
    - 分布式数据库就不同了，在维持关系型数据库特性不变的基础上，它可以通过**水平扩展**，也就是增加机器数量的方式，提供远高于单体数据库的并发量。这个并发量几乎不受 单机性能限制，我将这个级别的并发量称为“海量并发”。
  - 定义 3.0 + 高可靠
    - 我猜你会建议用 RAID(独立冗余磁盘阵列)来提高磁盘的可靠性。这确实是一个办法，但 也会带来性能上的损耗和存储空间上的损失。分布式数据库的副本机制可以比 RAID 更好地平衡可靠性、性能和空间利用率三者的关系。**副本机制就是将一份数据同时存储在多个 机器上，形成多个物理副本。**
    - 回到数据库的话题上，可靠性还要更复杂一点，包括两个度量指标，恢复时间目标 (Recovery Time Objective, RTO)和恢复点目标(Recovery Point Objective, RPO)。**RTO 是指故障恢复所花费的时间，可以等同于可靠性;RPO 则是指恢复服务后丢 失数据的数量。**
      - 数据库存储着重要数据，而金融行业的数据库更是关系到客户资产安全，不能容忍任何数 据丢失。所以，数据库高可靠意味着 RPO 等于 0，RTO 小于 5 分钟。
      - 分布式数据 库则是一个很好的备选方案，它**凭借节点之间的互为备份、自动切换的机制**，降低了 x86 服务器的单点故障对系统整体的影响，提供了高可靠性保障。
  - 定义 4.0 + 海量存储
    - 虽然单体数据库依靠外置存储设备可以扩展存储能力，但这种方式本质上不是数据库的能 力。现在，借助分布式的**横向扩展架构**，通过物理机的本地磁盘就可以获得强大的存储能 力，这让海量存储成为分布式数据库的标配。

- 内部构成
  - **客户端组件 + 单体数据库**
    - 通过独立的逻辑层建立数据分片和路由规则，实现单体数据库的初步管理，使应用能够对 接多个单体数据库，实现并发、存储能力的扩展。其作为应用系统的一部分，对业务侵入 较为深。
    - 这种客户端组件的典型产品是 Sharding-JDBC。
  - **代理中间件 + 单体数据库**
    - 以独立中间件的方式，管理数据规则和路由规则，以独立进程存在，与业务应用层和单体 数据库相隔离，减少了对应用的影响。随着代理中间件的发展，还会衍生出部分分布式事 务处理能力。
    - 这种中间件的典型产品是 MyCat。
  - **单元化架构 + 单体数据库**
    - 单元化架构是对业务应用系统的彻底重构，**应用系统被拆分成若干实例，配置独立的单体 数据库，让每个实例管理一定范围的数据。**例如对于银行贷款系统，可以为每个支行搭建 独立的应用实例，管理支行各自的用户，当出现跨支行业务时，由应用层代码通过分布式 事务组件保证事务的 ACID 特性。
  - 看过这三种方案，我相信你能够明白，它们共同的特点是单体数据库仍然能够被应用系统 感知到。相反，分布式数据库则是**将技术细节收敛到产品内部，以一个整体面对业务应用。**



## **强一致性**

- 强一致性意味着什么
  - 有人说，只要使用了 Paxos 或者 Raft算法，就可以实现强一致性;也有人说，根据 CAP 原理只能三选二，分区容忍性和高可用 性又是必不可少的，所以分布式数据库是做不到强一致性的。可是，**这些观点或多或少都 是有问题的**。
  - 对于分布式系统而言，一致性是在探讨当系统内的一份逻辑数据存在多个物理的数据副本 时，对其执行读写操作会产生什么样的结果，这也符合 CAP 理论对一致性的表述。
  - 而在数据库领域，“一致性”与事务密切相关，又进一步细化到 ACID 四个方面。其中，I 所代表的隔离性(Isolation)，是“一致性”的核心内容，研究的就是如何协调事务之间 的冲突。
  - 因此，当我们谈论分布式数据库的一致性时，实质上是在谈论**数据一致性**和**事务一致性**两个方面。
- **数据一致性**
  - 包括分布式数据库在内的分布式存储系统，为了避免设备与网络的不可靠带来的影响，通 常会存储多个数据副本。逻辑上的一份数据同时存储在多个物理副本上，自然带来了数据 一致性问题。
  - 强一致性:MySQL全同步复制
    - 显然，用户获得响应时，主库和备库的数据副本已经达成一致，所以后续的读操作肯定是 没有问题的，但这种模式的副作用非常大，体现在性能差、可用性问题。
    - 集群规模越大，这些问题就越严重，所以全同步复制模式在生产系统中也很少使用。更进 一步说，在工程实践中，实现状态视角的强一致性需要付出的代价太大，尤其是与可用性 有无法回避的冲突，所以很多产品选择了状态视角的弱一致性。
  - 弱一致性:NoSQL 最终一致性
    - NoSQL 产品是应用弱一致性的典型代表，但对弱一致性的接受仍然是有限度的，这就是 BASE 理论中的 E 所代表的最终一致性(Eventually Consistency)，弱于最终一致性的产 品就几乎没有了。
    - 对于最终一致性，你可以这样理解:在主副本执行写操作并反馈成功时，不要求其他副本 与主副本保持一致，但在经过一段时间后这些副本最终会追上主副本的进度，重新达到数 据状态的一致。
    - 你再仔细推敲一下，是不是觉得这个定义还有点含糊?“经过一段时间”到底是多久呢? 几秒还是几分钟?如果是一个不确定的数值，怎么在工程中使用呢?
- **操作视角**
  - **写后读一致性**











































